{"version":3,"file":"business.js","sourceRoot":"/","sources":["Utils/business.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;AAAA,qCAAiC;AACjC,mCAAmC;AAEnC,0CAA6G;AAC7G,qDAA8E;AAEvE,MAAM,gBAAgB,GAAG,CAAC,IAAgB,EAAE,EAAE;IACpD,MAAM,WAAW,GAAG,IAAA,6BAAkB,EAAC,IAAI,EAAE,iBAAiB,CAAC,CAAA;IAC/D,MAAM,QAAQ,GAAG,IAAA,gCAAqB,EAAC,WAAW,EAAE,SAAS,CAAC,CAAC,GAAG,CAAC,wBAAgB,CAAC,CAAA;IACpF,MAAM,MAAM,GAAG,IAAA,6BAAkB,EAAC,WAAW,EAAE,QAAQ,CAAC,CAAA;IAExD,OAAO;QACN,QAAQ;QACR,cAAc,EAAE,MAAM;YACrB,CAAC,CAAC,IAAA,mCAAwB,EAAC,MAAM,EAAE,OAAO,CAAC;YAC3C,CAAC,CAAC,SAAS;KACZ,CAAA;AACF,CAAC,CAAA;AAXY,QAAA,gBAAgB,oBAW5B;AAEM,MAAM,oBAAoB,GAAG,CAAC,IAAgB,EAAE,EAAE;IACxD,MAAM,eAAe,GAAG,IAAA,6BAAkB,EAAC,IAAI,EAAE,aAAa,CAAC,CAAA;IAC/D,MAAM,WAAW,GAAG,IAAA,gCAAqB,EAAC,eAAe,EAAE,YAAY,CAAC,CAAC,GAAG,CAC3E,cAAc,CAAC,EAAE;QAChB,MAAM,EAAE,GAAG,IAAA,mCAAwB,EAAC,cAAc,EAAE,IAAI,CAAE,CAAA;QAC1D,MAAM,IAAI,GAAG,IAAA,mCAAwB,EAAC,cAAc,EAAE,MAAM,CAAE,CAAA;QAE9D,MAAM,QAAQ,GAAG,IAAA,gCAAqB,EAAC,cAAc,EAAE,SAAS,CAAC,CAAC,GAAG,CAAC,wBAAgB,CAAC,CAAA;QACvF,OAAO;YACN,EAAE;YACF,IAAI;YACJ,QAAQ;YACR,MAAM,EAAE,eAAe,CAAC,cAAc,CAAC;SACvC,CAAA;IACF,CAAC,CACD,CAAA;IAED,OAAO;QACN,WAAW;KACX,CAAA;AACF,CAAC,CAAA;AApBY,QAAA,oBAAoB,wBAoBhC;AAEM,MAAM,qBAAqB,GAAG,CAAC,IAAgB,EAAE,EAAE;IACzD,MAAM,SAAS,GAAG,IAAA,6BAAkB,EAAC,IAAI,EAAE,OAAO,CAAC,CAAA;IACnD,MAAM,QAAQ,GAAG,IAAA,gCAAqB,EAAC,SAAS,EAAE,SAAS,CAAC,CAAC,GAAG,CAC/D,WAAW,CAAC,EAAE;QACb,MAAM,SAAS,GAAG,IAAA,6BAAkB,EAAC,WAAW,EAAE,OAAO,CAAE,CAAA;QAC3D,OAAO;YACN,EAAE,EAAE,IAAA,mCAAwB,EAAC,WAAW,EAAE,IAAI,CAAE;YAChD,IAAI,EAAE,IAAA,mCAAwB,EAAC,WAAW,EAAE,MAAM,CAAE;YACpD,QAAQ,EAAE,IAAA,mCAAwB,EAAC,SAAS,EAAE,KAAK,CAAE;YACrD,KAAK,EAAE,CAAC,IAAA,mCAAwB,EAAC,WAAW,EAAE,OAAO,CAAE;YACvD,QAAQ,EAAE,IAAA,mCAAwB,EAAC,WAAW,EAAE,UAAU,CAAE;YAC5D,QAAQ,EAAE,CAAC,IAAA,mCAAwB,EAAC,WAAW,EAAE,UAAU,CAAE;SAC7D,CAAA;IACF,CAAC,CACD,CAAA;IAED,MAAM,SAAS,GAAG,IAAA,6BAAkB,EAAC,SAAS,EAAE,OAAO,CAAC,CAAA;IAExD,MAAM,YAAY,GAAiB;QAClC,KAAK,EAAE;YACN,KAAK,EAAE,CAAC,IAAA,mCAAwB,EAAC,SAAS,EAAE,OAAO,CAAE;YACrD,QAAQ,EAAE,IAAA,mCAAwB,EAAC,SAAS,EAAE,UAAU,CAAE;SAC1D;QACD,QAAQ;KACR,CAAA;IAED,OAAO,YAAY,CAAA;AACpB,CAAC,CAAA;AA3BY,QAAA,qBAAqB,yBA2BjC;AAEM,MAAM,aAAa,GAAG,CAAC,SAA6B,EAAE,OAAsC,EAAE,EAAE;IACtG,MAAM,KAAK,GAAwB,EAAG,CAAA;IACtC,MAAM,OAAO,GAAiB,EAAG,CAAA;IAEjC,IAAG,OAAO,SAAS,KAAK,WAAW,EAAE;QACpC,OAAO,CAAC,IAAI,CAAC;YACZ,GAAG,EAAE,IAAI;YACT,KAAK,EAAE,EAAG;YACV,OAAO,EAAE,MAAM,CAAC,IAAI,CAAC,SAAS,CAAC;SAC/B,CAAC,CAAA;KACF;IAED,IAAG,OAAO,OAAO,CAAC,IAAI,KAAK,WAAW,EAAE;QACvC,OAAO,CAAC,IAAI,CAAC;YACZ,GAAG,EAAE,MAAM;YACX,KAAK,EAAE,EAAG;YACV,OAAO,EAAE,MAAM,CAAC,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC;SAClC,CAAC,CAAA;KACF;IAED,IAAG,OAAO,OAAO,CAAC,WAAW,KAAK,WAAW,EAAE;QAC9C,OAAO,CAAC,IAAI,CAAC;YACZ,GAAG,EAAE,aAAa;YAClB,KAAK,EAAE,EAAG;YACV,OAAO,EAAE,MAAM,CAAC,IAAI,CAAC,OAAO,CAAC,WAAW,CAAC;SACzC,CAAC,CAAA;KACF;IAED,IAAG,OAAO,OAAO,CAAC,UAAU,KAAK,WAAW,EAAE;QAC7C,OAAO,CAAC,IAAI,CAAC;YACZ,GAAG,EAAE,aAAa;YAClB,KAAK,EAAE,EAAG;YACV,OAAO,EAAE,MAAM,CAAC,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC;SACxC,CAAC,CAAA;KACF;IAED,IAAG,OAAO,CAAC,MAAM,CAAC,MAAM,EAAE;QACzB,OAAO,CAAC,IAAI,CAAC;YACZ,GAAG,EAAE,OAAO;YACZ,KAAK,EAAE,EAAG;YACV,OAAO,EAAE,OAAO,CAAC,MAAM,CAAC,GAAG,CAC1B,GAAG,CAAC,EAAE;gBACL,IAAG,CAAC,CAAC,KAAK,IAAI,GAAG,CAAC,EAAE;oBACnB,MAAM,IAAI,WAAI,CAAC,iDAAiD,EAAE,EAAE,UAAU,EAAE,GAAG,EAAE,CAAC,CAAA;iBACtF;gBAED,OAAO;oBACN,GAAG,EAAE,OAAO;oBACZ,KAAK,EAAE,EAAG;oBACV,OAAO,EAAE;wBACR;4BACC,GAAG,EAAE,KAAK;4BACV,KAAK,EAAE,EAAG;4BACV,OAAO,EAAE,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,QAAQ,EAAE,CAAC;yBACxC;qBACD;iBACD,CAAA;YACF,CAAC,CACD;SACD,CAAC,CAAA;KACF;IAED,IAAG,OAAO,OAAO,CAAC,KAAK,KAAK,WAAW,EAAE;QACxC,OAAO,CAAC,IAAI,CAAC;YACZ,GAAG,EAAE,OAAO;YACZ,KAAK,EAAE,EAAG;YACV,OAAO,EAAE,MAAM,CAAC,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,QAAQ,EAAE,CAAC;SAC9C,CAAC,CAAA;KACF;IAED,IAAG,OAAO,OAAO,CAAC,QAAQ,KAAK,WAAW,EAAE;QAC3C,OAAO,CAAC,IAAI,CAAC;YACZ,GAAG,EAAE,UAAU;YACf,KAAK,EAAE,EAAG;YACV,OAAO,EAAE,MAAM,CAAC,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC;SACtC,CAAC,CAAA;KACF;IAED,IAAG,mBAAmB,IAAI,OAAO,EAAE;QAClC,IAAG,OAAO,OAAO,CAAC,iBAAiB,KAAK,WAAW,EAAE;YACpD,KAAK,CAAC,qBAAqB,CAAC,GAAG,uBAAuB,CAAA;SACtD;aAAM;YACN,OAAO,CAAC,IAAI,CAAC;gBACZ,GAAG,EAAE,iBAAiB;gBACtB,KAAK,EAAE,EAAG;gBACV,OAAO,EAAE;oBACR;wBACC,GAAG,EAAE,qBAAqB;wBAC1B,KAAK,EAAE,EAAG;wBACV,OAAO,EAAE,MAAM,CAAC,IAAI,CAAC,OAAO,CAAC,iBAAiB,CAAC;qBAC/C;iBACD;aACD,CAAC,CAAA;SACF;KACD;IAGD,IAAG,OAAO,OAAO,CAAC,QAAQ,KAAK,WAAW,EAAE;QAC3C,KAAK,CAAC,WAAW,CAAC,GAAG,OAAO,CAAC,QAAQ,CAAC,QAAQ,EAAE,CAAA;KAChD;IAED,MAAM,IAAI,GAAe;QACxB,GAAG,EAAE,SAAS;QACd,KAAK;QACL,OAAO;KACP,CAAA;IACD,OAAO,IAAI,CAAA;AACZ,CAAC,CAAA;AA3GY,QAAA,aAAa,iBA2GzB;AAEM,MAAM,gBAAgB,GAAG,CAAC,WAAuB,EAAE,EAAE;IAC3D,MAAM,QAAQ,GAAG,WAAW,CAAC,KAAK,CAAC,SAAS,KAAK,MAAM,CAAA;IACvD,MAAM,EAAE,GAAG,IAAA,mCAAwB,EAAC,WAAW,EAAE,IAAI,CAAE,CAAA;IAEvD,MAAM,SAAS,GAAG,IAAA,6BAAkB,EAAC,WAAW,EAAE,OAAO,CAAE,CAAA;IAC3D,MAAM,cAAc,GAAG,IAAA,6BAAkB,EAAC,WAAW,EAAE,aAAa,CAAE,CAAA;IAEtE,MAAM,OAAO,GAAY;QACxB,EAAE;QACF,SAAS,EAAE,cAAc,CAAC,SAAS,CAAC;QACpC,YAAY,EAAE;YACb,QAAQ,EAAE,IAAA,mCAAwB,EAAC,cAAc,EAAE,QAAQ,CAAE;SAC7D;QACD,YAAY,EAAE,UAAU;QACxB,IAAI,EAAE,IAAA,mCAAwB,EAAC,WAAW,EAAE,MAAM,CAAE;QACpD,UAAU,EAAE,IAAA,mCAAwB,EAAC,WAAW,EAAE,aAAa,CAAC;QAChE,GAAG,EAAE,IAAA,mCAAwB,EAAC,WAAW,EAAE,KAAK,CAAC;QACjD,WAAW,EAAE,IAAA,mCAAwB,EAAC,WAAW,EAAE,aAAa,CAAE;QAClE,KAAK,EAAG,CAAC,IAAA,mCAAwB,EAAC,WAAW,EAAE,OAAO,CAAE;QACxD,QAAQ,EAAE,IAAA,mCAAwB,EAAC,WAAW,EAAE,UAAU,CAAE;QAC5D,QAAQ;KACR,CAAA;IAED,OAAO,OAAO,CAAA;AACf,CAAC,CAAA;AAxBY,QAAA,gBAAgB,oBAwB5B;AAED;;GAEG;AACH,SAAsB,iCAAiC,CAA0C,OAAU,EAAE,gBAAuC,EAAE,SAAS,GAAG,KAAM;;QACvK,OAAO,mCACH,OAAO,KACV,MAAM,EAAE,OAAO,CAAC,MAAM,CAAC,CAAC,CAAC,MAAM,IAAA,gCAAwB,EAAC,OAAO,CAAC,MAAM,EAAE,gBAAgB,EAAE,SAAS,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,MAAM,GACrH,CAAA;QACD,OAAO,OAAO,CAAA;IACf,CAAC;CAAA;AAND,8EAMC;AAED;;GAEG;AACI,MAAM,wBAAwB,GAAG,CACvC,MAAuB,EACvB,gBAAuC,EACvC,SAAS,GAAG,KAAM,EACjB,EAAE;IACH,MAAM,OAAO,GAAG,MAAM,OAAO,CAAC,GAAG,CAChC,MAAM,CAAC,GAAG,CACT,CAAM,GAAG,EAAC,EAAE;;QAEX,IAAG,KAAK,IAAI,GAAG,EAAE;YAChB,MAAM,GAAG,GAAG,GAAG,CAAC,GAAG,CAAC,QAAQ,EAAE,CAAA;YAC9B,IAAG,GAAG,CAAC,QAAQ,CAAC,eAAe,CAAC,EAAE;gBACjC,OAAO,EAAE,GAAG,EAAE,CAAA;aACd;SACD;QAED,MAAM,EAAE,MAAM,EAAE,GAAG,MAAM,IAAA,0BAAS,EAAC,GAAG,CAAC,CAAA;QACvC,MAAM,MAAM,GAAG,IAAA,mBAAU,EAAC,QAAQ,CAAC,CAAA;QACnC,MAAM,aAAa,GAAa,EAAE,CAAA;;YAClC,KAA0B,eAAA,WAAA,cAAA,MAAM,CAAA,YAAA,4EAAE;gBAAR,sBAAM;gBAAN,WAAM;gBAArB,MAAM,KAAK,KAAA,CAAA;gBACrB,MAAM,CAAC,MAAM,CAAC,KAAK,CAAC,CAAA;gBACpB,aAAa,CAAC,IAAI,CAAC,KAAK,CAAC,CAAA;aACzB;;;;;;;;;QAED,MAAM,GAAG,GAAG,MAAM,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAA;QAEnC,MAAM,EAAE,UAAU,EAAE,GAAG,MAAM,gBAAgB,CAC5C,IAAA,2BAAU,EAAC,MAAM,CAAC,MAAM,CAAC,aAAa,CAAC,CAAC,EACxC;YACC,SAAS,EAAE,uBAAuB;YAClC,gBAAgB,EAAE,GAAG;YACrB,SAAS;SACT,CACD,CAAA;QACD,OAAO,EAAE,GAAG,EAAE,IAAA,qCAAoB,EAAC,UAAU,CAAC,EAAE,CAAA;IACjD,CAAC,CAAA,CACD,CACD,CAAA;IACD,OAAO,OAAO,CAAA;AACf,CAAC,CAAA,CAAA;AAvCY,QAAA,wBAAwB,4BAuCpC;AAED,MAAM,cAAc,GAAG,CAAC,SAAqB,EAAE,EAAE;IAChD,MAAM,OAAO,GAAG,IAAA,6BAAkB,EAAC,SAAS,EAAE,OAAO,CAAC,CAAA;IACtD,OAAO;QACN,SAAS,EAAE,IAAA,mCAAwB,EAAC,OAAO,EAAE,mBAAmB,CAAE;QAClE,QAAQ,EAAE,IAAA,mCAAwB,EAAC,OAAO,EAAE,oBAAoB,CAAE;KAClE,CAAA;AACF,CAAC,CAAA;AAED,MAAM,eAAe,GAAG,CAAC,SAAqB,EAAiB,EAAE;IAChE,MAAM,IAAI,GAAG,IAAA,6BAAkB,EAAC,SAAS,EAAE,aAAa,CAAC,CAAA;IACzD,OAAO;QACN,MAAM,EAAE,IAAA,mCAAwB,EAAC,IAAI,EAAE,QAAQ,CAAE;QACjD,SAAS,EAAE,IAAA,mCAAwB,EAAC,IAAI,EAAE,YAAY,CAAC,KAAK,MAAM;KAClE,CAAA;AACF,CAAC,CAAA","sourcesContent":["import { Boom } from '@hapi/boom'\nimport { createHash } from 'crypto'\nimport { CatalogCollection, CatalogStatus, OrderDetails, OrderProduct, Product, ProductCreate, ProductUpdate, WAMediaUpload, WAMediaUploadFunction } from '../Types'\nimport { BinaryNode, getBinaryNodeChild, getBinaryNodeChildren, getBinaryNodeChildString } from '../WABinary'\nimport { getStream, getUrlFromDirectPath, toReadable } from './messages-media'\n\nexport const parseCatalogNode = (node: BinaryNode) => {\n\tconst catalogNode = getBinaryNodeChild(node, 'product_catalog')\n\tconst products = getBinaryNodeChildren(catalogNode, 'product').map(parseProductNode)\n\tconst paging = getBinaryNodeChild(catalogNode, 'paging')\n\n\treturn {\n\t\tproducts,\n\t\tnextPageCursor: paging\n\t\t\t? getBinaryNodeChildString(paging, 'after')\n\t\t\t: undefined\n\t}\n}\n\nexport const parseCollectionsNode = (node: BinaryNode) => {\n\tconst collectionsNode = getBinaryNodeChild(node, 'collections')\n\tconst collections = getBinaryNodeChildren(collectionsNode, 'collection').map<CatalogCollection>(\n\t\tcollectionNode => {\n\t\t\tconst id = getBinaryNodeChildString(collectionNode, 'id')!\n\t\t\tconst name = getBinaryNodeChildString(collectionNode, 'name')!\n\n\t\t\tconst products = getBinaryNodeChildren(collectionNode, 'product').map(parseProductNode)\n\t\t\treturn {\n\t\t\t\tid,\n\t\t\t\tname,\n\t\t\t\tproducts,\n\t\t\t\tstatus: parseStatusInfo(collectionNode)\n\t\t\t}\n\t\t}\n\t)\n\n\treturn {\n\t\tcollections\n\t}\n}\n\nexport const parseOrderDetailsNode = (node: BinaryNode) => {\n\tconst orderNode = getBinaryNodeChild(node, 'order')\n\tconst products = getBinaryNodeChildren(orderNode, 'product').map<OrderProduct>(\n\t\tproductNode => {\n\t\t\tconst imageNode = getBinaryNodeChild(productNode, 'image')!\n\t\t\treturn {\n\t\t\t\tid: getBinaryNodeChildString(productNode, 'id')!,\n\t\t\t\tname: getBinaryNodeChildString(productNode, 'name')!,\n\t\t\t\timageUrl: getBinaryNodeChildString(imageNode, 'url')!,\n\t\t\t\tprice: +getBinaryNodeChildString(productNode, 'price')!,\n\t\t\t\tcurrency: getBinaryNodeChildString(productNode, 'currency')!,\n\t\t\t\tquantity: +getBinaryNodeChildString(productNode, 'quantity')!\n\t\t\t}\n\t\t}\n\t)\n\n\tconst priceNode = getBinaryNodeChild(orderNode, 'price')\n\n\tconst orderDetails: OrderDetails = {\n\t\tprice: {\n\t\t\ttotal: +getBinaryNodeChildString(priceNode, 'total')!,\n\t\t\tcurrency: getBinaryNodeChildString(priceNode, 'currency')!,\n\t\t},\n\t\tproducts\n\t}\n\n\treturn orderDetails\n}\n\nexport const toProductNode = (productId: string | undefined, product: ProductCreate | ProductUpdate) => {\n\tconst attrs: BinaryNode['attrs'] = { }\n\tconst content: BinaryNode[] = [ ]\n\n\tif(typeof productId !== 'undefined') {\n\t\tcontent.push({\n\t\t\ttag: 'id',\n\t\t\tattrs: { },\n\t\t\tcontent: Buffer.from(productId)\n\t\t})\n\t}\n\n\tif(typeof product.name !== 'undefined') {\n\t\tcontent.push({\n\t\t\ttag: 'name',\n\t\t\tattrs: { },\n\t\t\tcontent: Buffer.from(product.name)\n\t\t})\n\t}\n\n\tif(typeof product.description !== 'undefined') {\n\t\tcontent.push({\n\t\t\ttag: 'description',\n\t\t\tattrs: { },\n\t\t\tcontent: Buffer.from(product.description)\n\t\t})\n\t}\n\n\tif(typeof product.retailerId !== 'undefined') {\n\t\tcontent.push({\n\t\t\ttag: 'retailer_id',\n\t\t\tattrs: { },\n\t\t\tcontent: Buffer.from(product.retailerId)\n\t\t})\n\t}\n\n\tif(product.images.length) {\n\t\tcontent.push({\n\t\t\ttag: 'media',\n\t\t\tattrs: { },\n\t\t\tcontent: product.images.map(\n\t\t\t\timg => {\n\t\t\t\t\tif(!('url' in img)) {\n\t\t\t\t\t\tthrow new Boom('Expected img for product to already be uploaded', { statusCode: 400 })\n\t\t\t\t\t}\n\n\t\t\t\t\treturn {\n\t\t\t\t\t\ttag: 'image',\n\t\t\t\t\t\tattrs: { },\n\t\t\t\t\t\tcontent: [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\ttag: 'url',\n\t\t\t\t\t\t\t\tattrs: { },\n\t\t\t\t\t\t\t\tcontent: Buffer.from(img.url.toString())\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t]\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t)\n\t\t})\n\t}\n\n\tif(typeof product.price !== 'undefined') {\n\t\tcontent.push({\n\t\t\ttag: 'price',\n\t\t\tattrs: { },\n\t\t\tcontent: Buffer.from(product.price.toString())\n\t\t})\n\t}\n\n\tif(typeof product.currency !== 'undefined') {\n\t\tcontent.push({\n\t\t\ttag: 'currency',\n\t\t\tattrs: { },\n\t\t\tcontent: Buffer.from(product.currency)\n\t\t})\n\t}\n\n\tif('originCountryCode' in product) {\n\t\tif(typeof product.originCountryCode === 'undefined') {\n\t\t\tattrs['compliance_category'] = 'COUNTRY_ORIGIN_EXEMPT'\n\t\t} else {\n\t\t\tcontent.push({\n\t\t\t\ttag: 'compliance_info',\n\t\t\t\tattrs: { },\n\t\t\t\tcontent: [\n\t\t\t\t\t{\n\t\t\t\t\t\ttag: 'country_code_origin',\n\t\t\t\t\t\tattrs: { },\n\t\t\t\t\t\tcontent: Buffer.from(product.originCountryCode)\n\t\t\t\t\t}\n\t\t\t\t]\n\t\t\t})\n\t\t}\n\t}\n\n\n\tif(typeof product.isHidden !== 'undefined') {\n\t\tattrs['is_hidden'] = product.isHidden.toString()\n\t}\n\n\tconst node: BinaryNode = {\n\t\ttag: 'product',\n\t\tattrs,\n\t\tcontent\n\t}\n\treturn node\n}\n\nexport const parseProductNode = (productNode: BinaryNode) => {\n\tconst isHidden = productNode.attrs.is_hidden === 'true'\n\tconst id = getBinaryNodeChildString(productNode, 'id')!\n\n\tconst mediaNode = getBinaryNodeChild(productNode, 'media')!\n\tconst statusInfoNode = getBinaryNodeChild(productNode, 'status_info')!\n\n\tconst product: Product = {\n\t\tid,\n\t\timageUrls: parseImageUrls(mediaNode),\n\t\treviewStatus: {\n\t\t\twhatsapp: getBinaryNodeChildString(statusInfoNode, 'status')!,\n\t\t},\n\t\tavailability: 'in stock',\n\t\tname: getBinaryNodeChildString(productNode, 'name')!,\n\t\tretailerId: getBinaryNodeChildString(productNode, 'retailer_id'),\n\t\turl: getBinaryNodeChildString(productNode, 'url'),\n\t\tdescription: getBinaryNodeChildString(productNode, 'description')!,\n\t\tprice:  +getBinaryNodeChildString(productNode, 'price')!,\n\t\tcurrency: getBinaryNodeChildString(productNode, 'currency')!,\n\t\tisHidden,\n\t}\n\n\treturn product\n}\n\n/**\n * Uploads images not already uploaded to WA's servers\n */\nexport async function uploadingNecessaryImagesOfProduct<T extends ProductUpdate | ProductCreate>(product: T, waUploadToServer: WAMediaUploadFunction, timeoutMs = 30_000) {\n\tproduct = {\n\t\t...product,\n\t\timages: product.images ? await uploadingNecessaryImages(product.images, waUploadToServer, timeoutMs) : product.images\n\t}\n\treturn product\n}\n\n/**\n * Uploads images not already uploaded to WA's servers\n */\nexport const uploadingNecessaryImages = async(\n\timages: WAMediaUpload[],\n\twaUploadToServer: WAMediaUploadFunction,\n\ttimeoutMs = 30_000\n) => {\n\tconst results = await Promise.all(\n\t\timages.map<Promise<{ url: string }>>(\n\t\t\tasync img => {\n\n\t\t\t\tif('url' in img) {\n\t\t\t\t\tconst url = img.url.toString()\n\t\t\t\t\tif(url.includes('.whatsapp.net')) {\n\t\t\t\t\t\treturn { url }\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tconst { stream } = await getStream(img)\n\t\t\t\tconst hasher = createHash('sha256')\n\t\t\t\tconst contentBlocks: Buffer[] = []\n\t\t\t\tfor await (const block of stream) {\n\t\t\t\t\thasher.update(block)\n\t\t\t\t\tcontentBlocks.push(block)\n\t\t\t\t}\n\n\t\t\t\tconst sha = hasher.digest('base64')\n\n\t\t\t\tconst { directPath } = await waUploadToServer(\n\t\t\t\t\ttoReadable(Buffer.concat(contentBlocks)),\n\t\t\t\t\t{\n\t\t\t\t\t\tmediaType: 'product-catalog-image',\n\t\t\t\t\t\tfileEncSha256B64: sha,\n\t\t\t\t\t\ttimeoutMs\n\t\t\t\t\t}\n\t\t\t\t)\n\t\t\t\treturn { url: getUrlFromDirectPath(directPath) }\n\t\t\t}\n\t\t)\n\t)\n\treturn results\n}\n\nconst parseImageUrls = (mediaNode: BinaryNode) => {\n\tconst imgNode = getBinaryNodeChild(mediaNode, 'image')\n\treturn {\n\t\trequested: getBinaryNodeChildString(imgNode, 'request_image_url')!,\n\t\toriginal: getBinaryNodeChildString(imgNode, 'original_image_url')!\n\t}\n}\n\nconst parseStatusInfo = (mediaNode: BinaryNode): CatalogStatus => {\n\tconst node = getBinaryNodeChild(mediaNode, 'status_info')\n\treturn {\n\t\tstatus: getBinaryNodeChildString(node, 'status')!,\n\t\tcanAppeal: getBinaryNodeChildString(node, 'can_appeal') === 'true',\n\t}\n}"]}